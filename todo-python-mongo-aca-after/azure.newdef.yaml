
name: todo-python-mongo-aca
metadata:
  template: todo-python-mongo-aca@0.0.1-beta

services:
  web:
    project: ./src/web
    language: js
    host: infra.resources.appforweb
  api:
    project: ./src/api
    language: python
    host: infra.resources.appforapi

# `infra/` folder will be generated by infra property in .yaml (by azd future plan)
infra:
  provider: bicep
  resources:
    - name: web                         # should use code name
      type: azure.containerapp
    - name: api
      type: azure.containerapp
    - name: secretstore
      type: azure.keyvault
    - name: configstore
      type: azure.appconfig
    - name: database
      type: azure.cosmos.mongo
    - name: monitoring
      type: azure.applicationinsights

# support different stores: ['AppConfig', 'KeyVault', 'AppEnv'?, 'ACASecretStore'?] (by Timothy)
bindings:
  - source: infra.resources.web
    target: infra.resources.api         # by default, resolved as `Services_api: xxxxxx`
    connection: http
    store: infra.resources.configstore
    # metadata:           # optional, should equals to additionalConfigurations of SC
    #   - key:
    #     value:
    # customizationKeys:  # optional, need discuss
    #   - key:
    #   - value:
  - source: infra.resources.api
    target: infra.resources.databse     # by default, resolved as `ConnectionStrings__database: xxxxxx`
    connection: secret
    store: infra.resources.secretstore
  - source: infra.resources.api
    target: infra.resources.monitoring  # by default, resolved as `ConnectionStrings__monitoring: xxxxxx`
    auth: secret
    store: infra.resources.secretstore

# Q.#1 how to let users know the config key name, they know it from bicep previously and write code?